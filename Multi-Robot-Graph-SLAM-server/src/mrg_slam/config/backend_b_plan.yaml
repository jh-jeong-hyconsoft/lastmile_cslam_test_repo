# 서버 백엔드 B안 설정
# B안: 로봇의 키프레임 수신 → 전역 정합만 수행

# 전역 설정
global:
  use_sim_time: true
  map_frame_id: "world"

# B안: KeyframeEvent 수신 모드
keyframe_reception:
  mode: "event"  # "continuous" (A안) vs "event" (B안)
  buffer_size: 100
  timeout: 30.0  # 초 (키프레임 수신 대기 시간)

# 그래프 최적화 (서버는 고품질)
optimization:
  g2o_solver_type: "lm_var_cholmod"  # cholmod 없으면 기본 solver
  g2o_solver_num_iterations: 1024  # 전역 정합은 더 정밀하게
  g2o_verbose: false
  graph_update_interval: 5.0  # B안: 키프레임 도착 시 트리거
  save_graph: true

# 맵 생성 (전역 맵)
mapping:
  map_cloud_resolution: 0.1
  map_cloud_min_points_per_voxel: 2
  map_cloud_distance_far_thresh: 10000.0
  map_cloud_update_interval: 30.0  # B안: 낮은 주기 (대역폭 절약)

# 루프 클로저 (로봇 간 협업)
loop_closure:
  # 후보 탐색 (로봇 간)
  candidate_max_xy_distance: 15.0  # A안보다 넓게
  accum_distance_thresh_same_robot: 10.0  # B안: 로봇 내부는 이미 처리됨
  accum_distance_thresh_other_robot: 5.0
  
  # 정합
  fitness_score_max_range: 999999.0
  fitness_score_thresh: 0.4
  use_planar_registration_guess: false
  
  # 일관성 검사
  enable_loop_closure_consistency_check: true
  loop_closure_consistency_max_delta_trans: 0.5  # A안보다 관대
  loop_closure_consistency_max_delta_angle: 10.0  # deg
  
  # 정합 알고리즘
  registration_method: "FAST_GICP"
  reg_num_threads: 16  # 서버 CPU 활용
  reg_transformation_epsilon: 0.1
  reg_maximum_iterations: 128
  reg_max_correspondence_distance: 2.5

# 그래프 교환 (B안: 키프레임 기반)
graph_exchange:
  mode: "KEYFRAME_EVENT"  # B안 전용 모드
  min_keyframes_for_merge: 3  # 최소 키프레임 수
  merge_interval: 10.0  # 초

# 키프레임 처리
keyframe:
  # B안: 로봇이 보낸 키프레임을 그대로 사용
  accept_external_keyframes: true
  validate_keyframe_cloud: true
  min_cloud_points: 100

# 타 로봇 포인트 제거 (B안: 서버는 수행하지 않음)
robot_filtering:
  remove_points_radius: 0.0  # 비활성화

# GNSS (B안: 로봇의 RL이 담당)
gps:
  enable: false

# IMU (B안: 로봇이 담당)
imu:
  enable_orientation: false
  enable_acceleration: false

# 결과 저장
output:
  result_dir: "/data/graphs"
  auto_save_interval: 600  # 초
  publish_global_map: true
  global_map_rate: 0.1  # Hz (선택, 저율)

# 포즈 힌트 발행 (B안: 로봇에 재배포)
pose_hint:
  enable: true
  publish_rate: 1.0  # Hz
  topics:
    - "/global/pose_hint/robot1"
    - "/global/pose_hint/robot2"
    - "/global/pose_hint/robot3"

